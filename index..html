<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Rescisão - Dr. Marcílio</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --cor-primaria: #004b8d;
            --cor-secundaria: #337ab7;
            --cor-fundo: #f4f7f9;
            --cor-card: #ffffff;
            --cor-texto: #333333;
            --cor-borda: #e0e0e0;
            --cor-sucesso: #28a745;
            --cor-alerta: #ffc107;
            --cor-erro: #dc3545;
            --cor-sombra: rgba(0, 0, 0, 0.1);
            --cor-sombra-escura: rgba(0, 0, 0, 0.2);
            --transicao: all 0.3s ease;
        }

        /* Tema Escuro */
        body.dark-theme {
            --cor-fundo: #1c1c1c;
            --cor-card: #2c2c2c;
            --cor-texto: #f0f0f0;
            --cor-borda: #444444;
            --cor-sucesso: #21b846;
            --cor-alerta: #ffeb3b;
            --cor-erro: #e8586c;
            --cor-sombra: rgba(255, 255, 255, 0.05);
            --cor-sombra-escura: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            line-height: 1.6;
            transition: var(--transicao);
        }

        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            background: var(--cor-primaria);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--cor-sombra-escura);
        }

        .header h1 {
            margin: 0 0 5px;
            font-size: 1.8em;
            font-weight: 700;
        }

        .header p {
            margin: 0;
            font-size: 0.9em;
            font-weight: 400;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background-color: var(--cor-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--cor-sombra);
            transition: var(--transicao);
        }

        .card h2 {
            margin-top: 0;
            color: var(--cor-primaria);
            border-bottom: 2px solid var(--cor-borda);
            padding-bottom: 10px;
        }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--cor-borda);
            border-radius: 8px;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--cor-secundaria);
            box-shadow: 0 0 0 2px rgba(51, 122, 183, 0.2);
        }

        .form-group.horizontal {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
        }
        
        .form-group.horizontal label {
            margin-bottom: 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--cor-borda);
        }

        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--cor-texto);
            font-weight: 600;
            transition: var(--transicao);
        }

        .tab-button.active {
            border-bottom: 3px solid var(--cor-primaria);
            color: var(--cor-primaria);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transicao);
        }

        .btn-primary {
            background-color: var(--cor-primaria);
            color: white;
            box-shadow: 0 4px 6px var(--cor-sombra);
        }

        .btn-primary:hover {
            background-color: #003e7a;
            box-shadow: 0 6px 10px var(--cor-sombra-escura);
        }

        .btn-secondary {
            background-color: var(--cor-card);
            color: var(--cor-primaria);
            border: 1px solid var(--cor-primaria);
        }

        .btn-secondary:hover {
            background-color: var(--cor-fundo);
        }
        
        .btn-export {
            background-color: var(--cor-sucesso);
            color: white;
        }

        .btn-export:hover {
            background-color: #218838;
        }

        .btn-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--cor-card);
            border: 1px solid var(--cor-borda);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px var(--cor-sombra);
            transition: var(--transicao);
        }
        
        .btn-toggle:hover {
            transform: scale(1.05);
        }

        .btn-toggle .icon {
            font-size: 20px;
            color: var(--cor-texto);
        }

        #result-section {
            display: none;
        }

        .summary-card {
            background-color: var(--cor-primaria);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px var(--cor-sombra-escura);
        }

        .summary-card p {
            margin: 0;
            font-size: 1.2em;
            opacity: 0.8;
        }

        .summary-card h3 {
            margin: 5px 0 0;
            font-size: 2.5em;
            font-weight: 700;
        }

        .summary-card.negative {
            background-color: var(--cor-erro);
        }
        
        .result-details {
            margin-top: 20px;
        }
        
        .result-details table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            display: block; /* Para permitir o scroll horizontal */
            overflow-x: auto;
        }

        .result-details table th, .result-details table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--cor-borda);
        }

        .result-details table th {
            background-color: var(--cor-fundo);
            font-weight: 600;
        }
        
        .valor-devido { color: var(--cor-sucesso); font-weight: 600; }
        .valor-desconto { color: var(--cor-erro); font-weight: 600; }

        .legal-notes {
            margin-top: 20px;
            padding-left: 20px;
            list-style: disc;
        }
        
        .legal-notes li {
            margin-bottom: 8px;
        }

        .disclaimer-rodape {
            text-align: center;
            font-size: 0.8em;
            color: #888;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid var(--cor-borda);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: var(--cor-card);
            color: var(--cor-texto);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--cor-borda);
            box-shadow: 0 2px 5px var(--cor-sombra);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--cor-borda) transparent transparent transparent;
        }
        
        body.dark-theme .tooltip .tooltiptext::after {
            border-color: var(--cor-borda) transparent transparent transparent;
        }
        
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--cor-card);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px var(--cor-sombra-escura);
            z-index: 1000;
            display: none;
            text-align: center;
            max-width: 350px;
        }
        
        .message-box h3 {
            margin-top: 0;
            color: var(--cor-primaria);
        }
        
        .message-box p {
            margin: 15px 0;
        }
        
        .message-box button {
            background-color: var(--cor-primaria);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Estilos para impressão */
        @media print {
            body {
                background: none;
                padding: 0;
                color: #000;
            }
            .container {
                max-width: none;
                width: 100%;
            }
            .header, .form-section, .btn-group, .disclaimer-rodape, #scenario-comparison, .btn-toggle {
                display: none;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 15px;
                margin-bottom: 20px;
            }
            #result-section {
                display: block !important;
                margin-top: 0;
            }
            .report-logo {
                display: block !important;
                margin: 0 auto 20px;
                text-align: center;
            }
            .report-logo h1 {
                margin: 0;
                color: var(--cor-primaria);
            }
            .summary-card {
                background-color: var(--cor-fundo);
                color: var(--cor-texto);
                border: 1px solid var(--cor-borda);
            }
            .valor-devido, .valor-desconto {
                color: inherit;
            }
        }
        
        .report-logo {
            display: none;
        }
        
        /* Tema Escuro para o logo no relatório */
        body.dark-theme .report-logo h1 {
            color: var(--cor-primaria);
        }

        /* Cenários comparativos */
        #scenario-comparison {
            display: none;
            margin-top: 20px;
        }

        #scenario-comparison table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            display: block; /* Para permitir o scroll horizontal */
            overflow-x: auto;
            white-space: nowrap; /* Impede a quebra de linha nas células */
        }

        #scenario-comparison table th, #scenario-comparison table td {
            padding: 12px;
            border: 1px solid var(--cor-borda);
            text-align: center;
        }
        
        #scenario-comparison table th {
            background-color: var(--cor-primaria);
            color: white;
        }
        
        #scenario-comparison table tr:nth-child(even) {
            background-color: var(--cor-fundo);
        }
        
        #scenario-comparison table td:first-child {
            text-align: left;
            font-weight: 600;
            white-space: normal;
        }
        
        /* Otimizações para telas pequenas */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .card {
                padding: 15px;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .form-group.horizontal {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .btn {
                width: 100%;
            }
        }

        /* Tooltip para o FGTS */
        #fgts-estimation-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #fgts-estimation-group label {
            white-space: nowrap;
        }

        .horizontal-spaced {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        /* Novo estilo para o alinhamento da pergunta */
        .form-group.spaced-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
        }
        
        .form-group.spaced-row .label-and-tooltip {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <button id="theme-toggle" class="btn-toggle">
        <span class="icon">🌙</span>
    </button>
    <div class="container">
        <div class="header">
            <h1>Calculadora de Rescisão — Dr. Marcílio</h1>
            <p>Estimativa de verbas rescisórias conforme a CLT</p>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="tabs">
                    <button class="tab-button active" data-tab="tab-basico">Básico</button>
                    <button class="tab-button" data-tab="tab-avancado">Avançado</button>
                </div>

                <form id="rescisao-form">
                    <div id="tab-basico" class="tab-content active">
                        <h2>Dados Essenciais</h2>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="tipoDesligamento">Tipo de Desligamento</label>
                                <select id="tipoDesligamento" required>
                                    <option value="">Selecione...</option>
                                    <option value="sem-justa-causa">Sem Justa Causa</option>
                                    <option value="pedido-demissao">Pedido de Demissão</option>
                                    <option value="justa-causa">Justa Causa</option>
                                    <option value="acordo">Acordo (Art. 484-A)</option>
                                    <option value="rescisao-indireta">Rescisão Indireta</option>
                                    <option value="termino-experiencia">Término Contrato Experiência</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="salarioBase">Salário Base Mensal (R$)</label>
                                <input type="text" id="salarioBase" class="currency" value="1518,00" required>
                            </div>
                            <div class="form-group">
                                <label for="dataAdmissao">Data de Admissão</label>
                                <input type="date" id="dataAdmissao" value="2024-01-15" required>
                            </div>
                            <div class="form-group">
                                <label for="dataDesligamento">Data de Desligamento</label>
                                <input type="date" id="dataDesligamento" value="2024-08-28" required>
                            </div>
                            <div class="form-group" id="aviso-group">
                                <label for="avisoModelo">Aviso Prévio</label>
                                <select id="avisoModelo" required>
                                    <option value="trabalhado">Trabalhado</option>
                                    <option value="indenizado">Indenizado</option>
                                    <option value="nao-cumprido">Não Cumprido (Descontar)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="faltasDescontos">Faltas/Descontos no Mês (R$)</label>
                                <input type="text" id="faltasDescontos" class="currency" value="0,00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="fgtsOption">Saldo do FGTS</label>
                            <select id="fgtsOption" required>
                                <option value="informar">Informar Saldo Total</option>
                                <option value="estimar">Estimar Saldo</option>
                            </select>
                        </div>
                        <div class="form-group" id="fgts-informado-group">
                            <label for="fgtsSaldo">Saldo Total de FGTS (R$)</label>
                            <input type="text" id="fgtsSaldo" class="currency" value="5000,00" required>
                        </div>
                        <div class="form-group" id="fgts-estimar-group" style="display: none;">
                            <label for="fgtsMeses">Meses de Contribuição</label>
                            <input type="number" id="fgtsMeses" value="12" min="1" required>
                        </div>

                        <div class="form-group spaced-row">
                            <div class="label-and-tooltip">
                                <label for="feriasVencidas" style="white-space: nowrap;">Possui Férias vencidas?</label>
                                <div class="tooltip">
                                    <span class="tooltip-icon">ⓘ</span>
                                    <span class="tooltiptext">Marque esta opção se o trabalhador possui um período aquisitivo de férias de 12 meses completo, mas ainda não gozou do descanso.</span>
                                </div>
                            </div>
                            <input type="checkbox" id="feriasVencidas">
                        </div>
                        <div class="form-group">
                            <label for="observacoes">Observacoes</label>
                            <textarea id="observacoes" rows="3" placeholder="Insira aqui informações adicionais para o relatório..."></textarea>
                        </div>
                    </div>

                    <div id="tab-avancado" class="tab-content">
                        <h2>Opções Avançadas</h2>
                        <h3>Médias e Adicionais</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="mediaHorasExtras">Média de Horas Extras mensais (R$)</label>
                                <input type="text" id="mediaHorasExtras" class="currency" value="0,00">
                            </div>
                            <div class="form-group">
                                <label for="mediaAdicionais">Média de Adicionais (R$) <small>(Periculosidade, Insalubridade)</small></label>
                                <input type="text" id="mediaAdicionais" class="currency" value="0,00">
                            </div>
                            <div class="form-group">
                                <label for="mediaComissoes">Média de Comissões mensais (R$)</label>
                                <input type="text" id="mediaComissoes" class="currency" value="0,00">
                            </div>
                        </div>

                        <h3>Descontos</h3>
                        <div class="form-group horizontal-spaced">
                            <label for="pensaoAbre">Pensão Alimentícia?</label>
                            <input type="checkbox" id="pensaoAbre">
                        </div>
                        <div class="form-group" id="pensao-group" style="display: none;">
                            <label for="pensaoValor">Valor da Pensão</label>
                            <input type="text" id="pensaoValor" class="currency" value="200,00" placeholder="R$">
                        </div>

                        <h3>Tabelas INSS/IRRF</h3>
                        <p><small>Valores baseados na tabela de 2024, editáveis para atualização.</small></p>
                        <div class="tabelas-container">
                            <h4>Tabela INSS (Alíquota x Parcela a deduzir)</h4>
                            <div id="inss-table-editor"></div>
                            <h4>Tabela IRRF (Alíquota x Parcela a deduzir)</h4>
                            <div id="irrf-table-editor"></div>
                        </div>
                        
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Calcular</button>
                        <button type="button" id="compare-btn" class="btn btn-secondary">Comparar Cenários</button>
                        <button type="button" id="limpar-btn" class="btn btn-secondary">Limpar</button>
                    </div>
                </form>
            </div>

            <div id="scenario-comparison" class="card">
                <h2>Comparador de Cenários</h2>
                <table id="comparison-table">
                    <thead>
                        <tr>
                            <th>Verba</th>
                            <th>Sem Justa Causa</th>
                            <th>Pedido de Demissão</th>
                            <th>Justa Causa</th>
                            <th>Acordo (484-A)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="result-section" class="card">
                <div class="report-logo">
                    <h1>Dr. Marcílio</h1>
                    <p>Advocacia Trabalhista</p>
                    <p>Relatório de Estimativa de Rescisão - <span id="report-date"></span></p>
                </div>
                <h2>Resultado da Simulação</h2>
                <div class="summary-card">
                    <p>Líquido a Receber</p>
                    <h3 id="valor-liquido">R$ 0,00</h3>
                </div>
                <div class="result-details">
                    <p>Total Bruto: <strong id="valor-bruto">R$ 0,00</strong></p>
                    <p>Total de Descontos: <strong id="valor-descontos">R$ 0,00</strong></p>

                    <h3>Memória de Cálculo</h3>
                    <table id="calculation-table">
                        <thead>
                            <tr>
                                <th>Verba</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div id="legal-warnings">
                        <h3>Avisos Legais</h3>
                        <ul class="legal-notes"></ul>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" id="print-btn" class="btn btn-secondary">Imprimir</button>
                    <button type="button" id="pdf-btn" class="btn btn-secondary btn-export">Exportar PDF</button>
                    <button type="button" id="share-btn" class="btn btn-secondary">Compartilhar Link</button>
                    <button type="button" id="whatsapp-btn" class="btn btn-secondary">Enviar via WhatsApp</button>
                </div>
            </div>
            
            <div class="card about-section">
                <h2>Sobre o Dr. Marcílio</h2>
                <p>O Dr. Marcílio é um advogado trabalhista com vasta experiência em direitos do trabalhador e causas rescisórias. Esta ferramenta foi desenvolvida com o objetivo de fornecer uma estimativa educativa e simplificada, com base na legislação da Consolidação das Leis do Trabalho (CLT).</p>
                <p>Para um cálculo oficial e uma orientação jurídica completa, que leve em conta sua convenção coletiva e especificidades do caso, entre em contato:</p>
                <p>Email: marciliiochagas@outlook.com<br>Telefone/WhatsApp: +55 (38) 99231-7937</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <a href="https://api.whatsapp.com/send?phone=5538992317937" target="_blank" style="padding: 10px 15px; background-color: #25D366; color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        Fale no WhatsApp
                    </a>
                    <a href="mailto:marciliiochagas@outlook.com" style="padding: 10px 15px; background-color: var(--cor-secundaria); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        Envie um Email
                    </a>
                </div>
            </div>
        </div>

        <div class="disclaimer-rodape">
            <p>Ferramenta de estimativa. Regras podem variar por convenção coletiva, adicionais, decisões judiciais e atualizações legais. Consulte o Advogado Marcílio para cálculo oficial e orientação.</p>
        </div>
    </div>
    
    <div id="message-box" class="message-box">
        <h3 id="message-title"></h3>
        <p id="message-text"></p>
        <button id="message-ok-btn">OK</button>
    </div>

    <script>
        // Mapeamento de DOM e variáveis globais
        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);

        const form = $('#rescisao-form');
        const tipoDesligamentoSelect = $('#tipoDesligamento');
        const avisoGroup = $('#aviso-group');
        const fgtsOptionSelect = $('#fgtsOption');
        const fgtsInformadoGroup = $('#fgts-informado-group');
        const fgtsEstimarGroup = $('#fgts-estimar-group');
        const pensaoAbreCheckbox = $('#pensaoAbre');
        const pensaoGroup = $('#pensao-group');
        const resultSection = $('#result-section');
        const valorLiquido = $('#valor-liquido');
        const valorBruto = $('#valor-bruto');
        const valorDescontos = $('#valor-descontos');
        const calculationTableBody = $('#calculation-table tbody');
        const legalNotesList = $('.legal-notes');
        const themeToggle = $('#theme-toggle');
        const compareBtn = $('#compare-btn');
        const limparBtn = $('#limpar-btn');
        const comparisonTableBody = $('#comparison-table tbody');
        const scenarioComparisonSection = $('#scenario-comparison');
        const printBtn = $('#print-btn');
        const pdfBtn = $('#pdf-btn');
        const shareBtn = $('#share-btn');
        const whatsappBtn = $('#whatsapp-btn');
        const reportDateSpan = $('#report-date');

        // Constantes e tabelas (base 2024, editáveis)
        const inssTabela = [
            { limite: 1412.00, aliquota: 0.075, deducao: 0.00 },
            { limite: 2666.68, aliquota: 0.09, deducao: 21.18 },
            { limite: 4000.03, aliquota: 0.12, deducao: 101.18 },
            { limite: 7786.02, aliquota: 0.14, deducao: 181.18 }
        ];

        const irrfTabela = [
            { limite: 2259.20, aliquota: 0.0, deducao: 0.00 },
            { limite: 2826.65, aliquota: 0.075, deducao: 169.44 },
            { limite: 3751.05, aliquota: 0.15, deducao: 381.44 },
            { limite: 4664.68, aliquota: 0.225, deducao: 662.77 },
            { limite: Infinity, aliquota: 0.275, deducao: 896.00 }
        ];

        const inssTeto = 7786.02;

        const seguroDesempregoTabela = [
            { limite: 2041.39, aliquota: 0.8, parcelaFixa: 0.0 },
            { limite: 3409.52, aliquota: 0.5, parcelaFixa: 816.55 },
            { limite: Infinity, aliquota: 0.0, parcelaFixa: 2313.74 }
        ];

        // Mapeamento de tipos de rescisão para regras
        const regrasRescisao = {
            'sem-justa-causa': {
                multaFgts: 0.40,
                avisoPrevio: true,
                fgtsSaque: true,
                seguroDesemprego: true,
                avisoDesconta: false,
                decimoTerceiro: true,
                feriasProporcionais: true,
                verbas: ['Saldo de Salário', 'Aviso Prévio', '13º Salário', 'Férias Vencidas', 'Férias Proporcionais', 'Multa FGTS']
            },
            'pedido-demissao': {
                multaFgts: 0.0,
                avisoPrevio: true,
                fgtsSaque: false,
                seguroDesemprego: false,
                avisoDesconta: true,
                decimoTerceiro: true,
                feriasProporcionais: true,
                verbas: ['Saldo de Salário', '13º Salário', 'Férias Vencidas', 'Férias Proporcionais']
            },
            'justa-causa': {
                multaFgts: 0.0,
                avisoPrevio: false,
                fgtsSaque: false,
                seguroDesemprego: false,
                avisoDesconta: false,
                decimoTerceiro: false,
                feriasProporcionais: false,
                verbas: ['Saldo de Salário', 'Férias Vencidas']
            },
            'acordo': {
                multaFgts: 0.20,
                avisoPrevio: true,
                aviso50p: true,
                fgtsSaque: true,
                seguroDesemprego: false,
                avisoDesconta: false,
                decimoTerceiro: true,
                feriasProporcionais: true,
                verbas: ['Saldo de Salário', 'Aviso Prévio (50%)', '13º Salário', 'Férias Vencidas', 'Férias Proporcionais', 'Multa FGTS (20%)']
            },
            'rescisao-indireta': {
                multaFgts: 0.40,
                avisoPrevio: true,
                fgtsSaque: true,
                seguroDesemprego: true,
                avisoDesconta: false,
                decimoTerceiro: true,
                feriasProporcionais: true,
                verbas: ['Saldo de Salário', 'Aviso Prévio', '13º Salário', 'Férias Vencidas', 'Férias Proporcionais', 'Multa FGTS']
            },
            'termino-experiencia': {
                multaFgts: 0.0,
                avisoPrevio: false,
                fgtsSaque: true,
                seguroDesemprego: false,
                avisoDesconta: false,
                decimoTerceiro: true,
                feriasProporcionais: true,
                verbas: ['Saldo de Salário', '13º Salário', 'Férias Vencidas', 'Férias Proporcionais', 'Saque FGTS (sim)']
            }
        };

        // Funções de formatação e utilitários
        function parseCurrency(value) {
            if (!value) return 0;
            return parseFloat(value.replace(/\./g, '').replace(',', '.'));
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatDate(date) {
            return date.toLocaleDateString('pt-BR');
        }

        function showMessage(title, message, isError = false) {
            const msgBox = $('#message-box');
            const msgTitle = $('#message-title');
            const msgText = $('#message-text');
            const msgBtn = $('#message-ok-btn');
            
            msgTitle.textContent = title;
            msgText.textContent = message;
            msgBox.style.display = 'block';
            msgBtn.onclick = () => msgBox.style.display = 'none';
        }

        // Funções de cálculo
        function getMonthsWorked(admissao, desligamento, consideraDiaUtil) {
            const dataAdmissao = new Date(admissao);
            const dataDesligamento = new Date(desligamento);
            const diaDesligamento = dataDesligamento.getDate();

            let mesesTrabalhados = 0;
            let anoAtual = dataAdmissao.getFullYear();
            let mesAtual = dataAdmissao.getMonth();

            while (new Date(anoAtual, mesAtual, 1) < dataDesligamento) {
                mesesTrabalhados++;
                mesAtual++;
                if (mesAtual > 11) {
                    mesAtual = 0;
                    anoAtual++;
                }
            }

            // Mês do desligamento
            if (consideraDiaUtil && diaDesligamento >= 15) {
                return mesesTrabalhados + 1;
            } else if (!consideraDiaUtil) {
                return mesesTrabalhados;
            }
            return mesesTrabalhados;
        }
        
        function getAnosCompletos(admissao, desligamento) {
            const start = new Date(admissao);
            const end = new Date(desligamento);
            let years = end.getFullYear() - start.getFullYear();
            
            // Ajusta se o aniversário de contrato ainda não chegou
            if (end.getMonth() < start.getMonth() || (end.getMonth() === start.getMonth() && end.getDate() < start.getDate())) {
                years--;
            }
            return years;
        }

        function calcSalarioSaldo(salario, dataDesligamento) {
            const diasNoMes = new Date(dataDesligamento.getFullYear(), dataDesligamento.getMonth() + 1, 0).getDate();
            const diasTrabalhados = dataDesligamento.getDate();
            return (salario / diasNoMes) * diasTrabalhados;
        }

        function calcAvisoPrevio(salarioBase, mediaVerbas, dataAdmissao, dataDesligamento) {
            const salarioComMedias = salarioBase + mediaVerbas;
            const anosCompletos = getAnosCompletos(dataAdmissao, dataDesligamento);
            const diasAviso = 30 + Math.min(60, anosCompletos * 3); // Limite de 90 dias
            
            return (salarioComMedias / 30) * diasAviso;
        }

        function calcDecimoTerceiro(salarioBase, mediaVerbas, dataAdmissao, dataDesligamento) {
            const salarioComMedias = salarioBase + mediaVerbas;
            let mesesProporcionais = 0;
            let mesAdmissao = new Date(dataAdmissao).getMonth();
            let mesDesligamento = new Date(dataDesligamento).getMonth();
            let anoAdmissao = new Date(dataAdmissao).getFullYear();
            let anoDesligamento = new Date(dataDesligamento).getFullYear();

            if (anoAdmissao === anoDesligamento) {
                mesesProporcionais = (mesDesligamento - mesAdmissao) + 1;
            } else {
                mesesProporcionais = (12 - mesAdmissao) + (mesDesligamento + 1);
            }
            
            // Verifica se trabalhou 15 dias no mês de desligamento
            const diaDesligamento = new Date(dataDesligamento).getDate();
            if (diaDesligamento < 15) {
                mesesProporcionais--;
            }

            return (salarioComMedias / 12) * mesesProporcionais;
        }

        function calcFeriasProporcionais(salarioBase, mediaVerbas, dataAdmissao, dataDesligamento) {
            const salarioComMedias = salarioBase + mediaVerbas;
            const mesesTrabalhados = getMonthsWorked(dataAdmissao, dataDesligamento, true);
            const mesesAquisitivosIncompletos = mesesTrabalhados % 12;
            
            // Cálculo das férias proporcionais + 1/3
            return (salarioComMedias / 12) * mesesAquisitivosIncompletos * (4/3);
        }

        function calcFeriasVencidas(salarioBase, mediaVerbas) {
            const salarioComMedias = salarioBase + mediaVerbas;
            return salarioComMedias * (4/3);
        }
        
        function calcFgtsSaldo(fgtsOption, fgtsSaldo, fgtsMeses, salarioBase, mediaVerbas) {
            if (fgtsOption === 'informar') {
                return fgtsSaldo;
            } else {
                const salarioComMedias = salarioBase + mediaVerbas;
                return (salarioComMedias * 0.08) * fgtsMeses;
            }
        }
        
        function calcMultaFgts(fgtsSaldo, aliquota) {
            return fgtsSaldo * aliquota;
        }

        function calcINSS(salarioBase, verbas) {
            const baseINSS = Math.min(salarioBase + verbas, inssTeto);
            let inssValor = 0;
            let baseCalculo = baseINSS;
            
            // Calculo progressivo (usando faixas)
            for (let i = inssTabela.length - 1; i >= 0; i--) {
                const faixa = inssTabela[i];
                if (baseCalculo > faixa.limite) {
                    const valorFaixa = baseCalculo - faixa.limite;
                    inssValor += valorFaixa * faixa.aliquota;
                    baseCalculo = faixa.limite;
                }
            }
            
            // Alternativa simplificada usando parcela a deduzir
            for (let i = inssTabela.length - 1; i >= 0; i--) {
                const faixa = inssTabela[i];
                if (baseINSS > faixa.limite) {
                    return (baseINSS * faixa.aliquota) - faixa.deducao;
                }
            }
            return 0;
        }

        function calcIRRF(salarioBase, verbas, inssValor) {
            const baseIRRF = salarioBase + verbas - inssValor;
            let irrfValor = 0;

            // Calculo progressivo (usando parcela a deduzir)
            for (let i = irrfTabela.length - 1; i >= 0; i--) {
                const faixa = irrfTabela[i];
                if (baseIRRF > faixa.limite) {
                    return (baseIRRF * faixa.aliquota) - faixa.deducao;
                }
            }
            return 0;
        }
        
        // Função principal que agrega todos os cálculos
        function calcRescisao(data) {
            const {
                tipoDesligamento, salarioBase, dataAdmissao, dataDesligamento,
                avisoModelo, faltasDescontos, feriasVencidas,
                fgtsOption, fgtsSaldo, fgtsMeses,
                mediaHorasExtras, mediaAdicionais, mediaComissoes, pensaoAbre, pensaoValor
            } = data;
            
            // Converter strings de data para objetos Date
            const admissao = new Date(dataAdmissao);
            const desligamento = new Date(dataDesligamento);

            const regras = regrasRescisao[tipoDesligamento];
            
            const mediaVerbas = mediaHorasExtras + mediaAdicionais + mediaComissoes;
            
            let bruto = 0;
            let descontos = 0;
            const verbas = {};
            const notas = [];
            const elegibilidade = {
                fgtsSaque: regras.fgtsSaque,
                seguroDesemprego: regras.seguroDesemprego,
                avisoPrazo: 'Em até 10 dias corridos contados do término do contrato.'
            };
            
            let decimoTerceiro = 0;

            // 1. Saldo de Salário
            const saldoSalario = calcSalarioSaldo(salarioBase, desligamento);
            verbas['Saldo de Salário'] = { valor: saldoSalario, formula: 'Salário ÷ 30 dias × dias trabalhados no mês' };
            bruto += saldoSalario;

            // 2. Aviso Prévio (calculado para todos os cenários)
            const avisoPrevioValor = calcAvisoPrevio(salarioBase, mediaVerbas, admissao, desligamento);
            if (regras.avisoPrevio) {
                if (avisoModelo === 'indenizado' && !regras.aviso50p) {
                    verbas['Aviso Prévio Indenizado'] = { valor: avisoPrevioValor, formula: 'Salário Base + Médias' };
                    bruto += avisoPrevioValor;
                    notas.push('O aviso prévio indenizado é uma verba de natureza indenizatória, não incidindo sobre ele INSS e IRRF.');
                } else if (avisoModelo === 'trabalhado') {
                    verbas['Aviso Prévio Trabalhado'] = { valor: 0, formula: 'Aviso prévio trabalhado já está incluso no saldo de salário final.' };
                } else if (avisoModelo === 'nao-cumprido' && regras.avisoDesconta) {
                    verbas['Aviso Prévio Não Cumprido'] = { valor: -avisoPrevioValor, formula: 'Valor do aviso prévio é descontado por não ter sido cumprido.' };
                    descontos += avisoPrevioValor;
                }
            }
            // Regra do Acordo (Art. 484-A)
            if (regras.aviso50p) {
                 verbas['Aviso Prévio Indenizado (50%)'] = { valor: avisoPrevioValor / 2, formula: '50% do valor do aviso prévio indenizado' };
                 bruto += avisoPrevioValor / 2;
            }

            // 3. 13º Salário
            if (regras.decimoTerceiro) {
                decimoTerceiro = calcDecimoTerceiro(salarioBase, mediaVerbas, admissao, desligamento);
                verbas['13º Salário Proporcional'] = { valor: decimoTerceiro, formula: '(Salário Base + Médias) x (Meses/12)' };
                bruto += decimoTerceiro;
            } else {
                verbas['13º Salário Proporcional'] = { valor: 0, formula: 'Não é devido em caso de Justa Causa.' };
            }

            // 4. Férias
            if (feriasVencidas && regras.feriasVencidas) {
                const feriasVencidasValor = calcFeriasVencidas(salarioBase, mediaVerbas);
                verbas['Férias Vencidas + 1/3'] = { valor: feriasVencidasValor, formula: 'Salário Base + Médias + 1/3 constitucional' };
                bruto += feriasVencidasValor;
            } else if (!regras.feriasVencidas) {
                verbas['Férias Vencidas + 1/3'] = { valor: 0, formula: 'Não é devido em caso de Justa Causa.' };
            }

            if (regras.feriasProporcionais) {
                const feriasProporcionais = calcFeriasProporcionais(salarioBase, mediaVerbas, admissao, desligamento);
                verbas['Férias Proporcionais + 1/3'] = { valor: feriasProporcionais, formula: '(Salário Base + Médias) x (Meses/12) + 1/3' };
                bruto += feriasProporcionais;
            } else {
                verbas['Férias Proporcionais + 1/3'] = { valor: 0, formula: 'Não é devido em caso de Justa Causa.' };
            }

            // 5. FGTS e Multa
            const fgtsSaldoCalculado = calcFgtsSaldo(fgtsOption, fgtsSaldo, fgtsMeses, salarioBase, mediaVerbas);
            verbas['FGTS Depositado'] = { valor: fgtsSaldoCalculado, formula: 'Estimativa baseada em meses trabalhados ou saldo informado.' };

            if (regras.multaFgts > 0) {
                const multaFgts = calcMultaFgts(fgtsSaldoCalculado, regras.multaFgts);
                verbas['Multa FGTS'] = { valor: multaFgts, formula: `${(regras.multaFgts * 100)}% do saldo total do FGTS.` };
                bruto += multaFgts;
            } else {
                verbas['Multa FGTS'] = { valor: 0, formula: 'Não é devido neste tipo de desligamento.' };
            }

            // 6. Descontos
            const baseINSS = saldoSalario + (regras.decimoTerceiro ? decimoTerceiro : 0);
            const inssValor = calcINSS(baseINSS, 0); // Ajustar base, somente verbas salariais
            verbas['INSS'] = { valor: -inssValor, formula: 'Desconto sobre o saldo de salário e 13º salário.' };
            descontos += inssValor;
            
            const baseIRRF = bruto - inssValor;
            const irrfValor = calcIRRF(baseIRRF, 0, 0); // O IRRF incide sobre o bruto - INSS
            verbas['IRRF'] = { valor: -irrfValor, formula: 'Desconto sobre a base de cálculo (Bruto - INSS).' };
            descontos += irrfValor;

            if (faltasDescontos > 0) {
                verbas['Outros Descontos'] = { valor: -faltasDescontos, formula: 'Faltas e outros adiantamentos informados.' };
                descontos += faltasDescontos;
            }

            if (pensaoAbre && pensaoValor > 0) {
                verbas['Pensão Alimentícia'] = { valor: -pensaoValor, formula: 'Valor da pensão alimentícia descontado.' };
                descontos += pensaoValor;
            }

            const liquido = bruto - descontos;
            
            return {
                bruto,
                descontos,
                liquido,
                verbas,
                notas,
                elegibilidade
            };
        }
        
        // Renderização da interface
        function renderResult(result, isComparison = false) {
            if (!isComparison) {
                valorBruto.textContent = formatCurrency(result.bruto);
                valorDescontos.textContent = formatCurrency(result.descontos);
                valorLiquido.textContent = formatCurrency(result.liquido);
                resultSection.style.display = 'block';

                if (result.liquido < 0) {
                    valorLiquido.textContent = formatCurrency(Math.abs(result.liquido)) + ' (Valor a Pagar)';
                    valorLiquido.parentElement.classList.add('negative');
                } else {
                    valorLiquido.parentElement.classList.remove('negative');
                }
                
                calculationTableBody.innerHTML = '';
                for (const [key, value] of Object.entries(result.verbas)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${key}</td>
                        <td><small>${value.formula}</small></td>
                        <td class="${value.valor >= 0 ? 'valor-devido' : 'valor-desconto'}">${formatCurrency(value.valor)}</td>
                    `;
                    calculationTableBody.appendChild(row);
                }

                legalNotesList.innerHTML = '';
                if (result.elegibilidade.fgtsSaque) {
                    legalNotesList.innerHTML += '<li><strong>Saque FGTS:</strong> Elegível.</li>';
                } else {
                    legalNotesList.innerHTML += '<li><strong>Saque FGTS:</strong> Não elegível, exceto em casos de doença grave ou compra da casa própria.</li>';
                }
                if (result.elegibilidade.seguroDesemprego) {
                    legalNotesList.innerHTML += '<li><strong>Seguro-Desemprego:</strong> Elegível, desde que preenchidos os demais requisitos legais.</li>';
                } else {
                    legalNotesList.innerHTML += '<li><strong>Seguro-Desemprego:</strong> Não elegível.</li>';
                }
                
                reportDateSpan.textContent = formatDate(new Date());

            } else {
                const tipo = result.tipoDesligamento;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${regrasRescisao[tipo].verbas.join(', ')}</td>
                    <td>${formatCurrency(result.liquido)}</td>
                `;
            }
        }
        
        function updateUIforType(tipo) {
            const regras = regrasRescisao[tipo];
            if (tipo === 'pedido-demissao') {
                avisoGroup.style.display = 'flex';
                $('#avisoModelo').value = 'nao-cumprido';
            } else if (tipo === 'sem-justa-causa' || tipo === 'rescisao-indireta') {
                avisoGroup.style.display = 'flex';
                $('#avisoModelo').value = 'indenizado';
            } else {
                avisoGroup.style.display = 'none';
            }
        }
        
        function updateFGTSFields() {
            if (fgtsOptionSelect.value === 'informar') {
                fgtsInformadoGroup.style.display = 'flex';
                fgtsEstimarGroup.style.display = 'none';
                $('#fgtsSaldo').setAttribute('required', 'required');
                $('#fgtsMeses').removeAttribute('required');
            } else {
                fgtsInformadoGroup.style.display = 'none';
                fgtsEstimarGroup.style.display = 'flex';
                $('#fgtsSaldo').removeAttribute('required');
                $('#fgtsMeses').setAttribute('required', 'required');
            }
        }
        
        function updatePensãoFields() {
            if (pensaoAbreCheckbox.checked) {
                pensaoGroup.style.display = 'flex';
                $('#pensaoValor').setAttribute('required', 'required');
            } else {
                pensaoGroup.style.display = 'none';
                $('#pensaoValor').removeAttribute('required');
            }
        }

        function createTableEditor(tableData, editorId) {
            const editor = $(`#${editorId}`);
            editor.innerHTML = '';
            tableData.forEach((row, index) => {
                const div = document.createElement('div');
                div.classList.add('form-group', 'horizontal');
                div.innerHTML = `
                    <label>Faixa ${index + 1}:</label>
                    <input type="text" class="currency" value="${formatCurrency(row.limite).replace('R$', '').trim()}" data-field="limite" data-index="${index}">
                    <label>Alíquota:</label>
                    <input type="number" step="0.001" value="${row.aliquota}" data-field="aliquota" data-index="${index}">
                `;
                editor.appendChild(div);
            });
        }
        
        // Lógica de exportação
        function exportToPDF() {
            const container = $('.container');
            const originalWidth = container.style.width;
            container.style.width = '1000px'; // Temporarily adjust width for better PDF rendering
            
            html2canvas(container, {
                scale: 2,
                logging: true,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight();
                }
                pdf.save('relatorio_rescisao.pdf');
                container.style.width = originalWidth; // Restore original width
            }).catch(err => {
                console.error("Erro ao gerar PDF:", err);
                showMessage("Erro na Exportação", "Ocorreu um erro ao gerar o PDF. Por favor, tente a impressão direta.");
            });
        }
        
        // Lógica de compartilhamento
        function getShareLink() {
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.set(key, value);
            }
            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }

        // Eventos
        window.addEventListener('load', () => {
            // Inicializa as tabelas de INSS/IRRF
            createTableEditor(inssTabela, 'inss-table-editor');
            createTableEditor(irrfTabela, 'irrf-table-editor');
            
            // Carrega estado da URL se existir
            const params = new URLSearchParams(window.location.search);
            if (params.size > 0) {
                for (const [key, value] of params.entries()) {
                    const input = $(`#${key}`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = value === 'on';
                        } else {
                            input.value = value;
                        }
                    }
                }
                updateUIforType(tipoDesligamentoSelect.value);
                updateFGTSFields();
                updatePensãoFields();
            }
        });

        $$('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                $$('.tab-button').forEach(btn => btn.classList.remove('active'));
                $$('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                $(`#${button.dataset.tab}`).classList.add('active');
            });
        });

        tipoDesligamentoSelect.addEventListener('change', (e) => updateUIforType(e.target.value));
        fgtsOptionSelect.addEventListener('change', updateFGTSFields);
        pensaoAbreCheckbox.addEventListener('change', updatePensãoFields);

        // Mascaramento de inputs
        $$('.currency').forEach(input => {
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                value = (value / 100).toFixed(2).replace('.', ',');
                value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                e.target.value = value;
            });
        });
        
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Reúne dados do formulário
            const formData = {
                tipoDesligamento: tipoDesligamentoSelect.value,
                salarioBase: parseCurrency($('#salarioBase').value),
                dataAdmissao: $('#dataAdmissao').value,
                dataDesligamento: $('#dataDesligamento').value,
                avisoModelo: $('#avisoModelo').value,
                faltasDescontos: parseCurrency($('#faltasDescontos').value),
                feriasVencidas: $('#feriasVencidas').checked,
                fgtsOption: fgtsOptionSelect.value,
                fgtsSaldo: parseCurrency($('#fgtsSaldo').value),
                fgtsMeses: parseInt($('#fgtsMeses').value) || 0,
                mediaHorasExtras: parseCurrency($('#mediaHorasExtras').value),
                mediaAdicionais: parseCurrency($('#mediaAdicionais').value),
                mediaComissoes: parseCurrency($('#mediaComissoes').value),
                pensaoAbre: pensaoAbreCheckbox.checked,
                pensaoValor: parseCurrency($('#pensaoValor').value)
            };
            
            // Executa o cálculo e renderiza
            const resultado = calcRescisao(formData);
            renderResult(resultado);
            
            scenarioComparisonSection.style.display = 'none';
        });

        compareBtn.addEventListener('click', () => {
            const formData = {
                salarioBase: parseCurrency($('#salarioBase').value),
                dataAdmissao: $('#dataAdmissao').value,
                dataDesligamento: $('#dataDesligamento').value,
                fgtsOption: fgtsOptionSelect.value,
                fgtsSaldo: parseCurrency($('#fgtsSaldo').value),
                fgtsMeses: parseInt($('#fgtsMeses').value) || 0,
                mediaHorasExtras: parseCurrency($('#mediaHorasExtras').value),
                mediaAdicionais: parseCurrency($('#mediaAdicionais').value),
                mediaComissoes: parseCurrency($('#mediaComissoes').value),
                pensaoAbre: pensaoAbreCheckbox.checked,
                pensaoValor: parseCurrency($('#pensaoValor').value),
                faltasDescontos: parseCurrency($('#faltasDescontos').value),
                feriasVencidas: $('#feriasVencidas').checked
            };
            
            const scenarios = ['sem-justa-causa', 'pedido-demissao', 'justa-causa', 'acordo'];
            comparisonTableBody.innerHTML = '';
            
            const results = scenarios.map(tipo => {
                const scenarioData = { ...formData, tipoDesligamento: tipo, avisoModelo: 'indenizado' };
                if (tipo === 'pedido-demissao') scenarioData.avisoModelo = 'nao-cumprido';
                return calcRescisao(scenarioData);
            });

            const verbasList = Array.from(new Set(scenarios.flatMap(tipo => regrasRescisao[tipo].verbas)));
            
            // Cria as linhas do comparativo
            const totalBrutoRow = document.createElement('tr');
            totalBrutoRow.innerHTML = `<td>Total Bruto</td>${results.map(r => `<td>${formatCurrency(r.bruto)}</td>`).join('')}`;
            comparisonTableBody.appendChild(totalBrutoRow);
            
            const totalDescontosRow = document.createElement('tr');
            totalDescontosRow.innerHTML = `<td>Total Descontos</td>${results.map(r => `<td>${formatCurrency(r.descontos)}</td>`).join('')}`;
            comparisonTableBody.appendChild(totalDescontosRow);
            
            const totalLiquidoRow = document.createElement('tr');
            totalLiquidoRow.innerHTML = `<td><strong>Líquido a Receber</strong></td>${results.map(r => `<td><strong>${formatCurrency(r.liquido)}</strong></td>`).join('')}`;
            comparisonTableBody.appendChild(totalLiquidoRow);
            
            scenarioComparisonSection.style.display = 'block';
            resultSection.style.display = 'none';
        });
        
        limparBtn.addEventListener('click', () => {
            const formInputs = form.querySelectorAll('input:not([type="button"]):not([type="submit"]), select, textarea');
            formInputs.forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            
            // Restaurar valores padrão
            $('#salarioBase').value = '1518,00';
            $('#dataAdmissao').value = '2024-01-15';
            $('#dataDesligamento').value = '2024-08-28';
            $('#fgtsSaldo').value = '5000,00';
            $('#fgtsMeses').value = '12';
            $('#mediaHorasExtras').value = '0,00';
            $('#mediaAdicionais').value = '0,00';
            $('#mediaComissoes').value = '0,00';
            $('#pensaoValor').value = '200,00';
            $('#faltasDescontos').value = '0,00';

            // Resetar visibilidade dos campos
            updateUIforType(tipoDesligamentoSelect.value);
            updateFGTSFields();
            updatePensãoFields();

            // Esconder seções de resultado
            resultSection.style.display = 'none';
            scenarioComparisonSection.style.display = 'none';
        });

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            themeToggle.innerHTML = isDark ? '<span class="icon">☀️</span>' : '<span class="icon">🌙</span>';
        });
        
        printBtn.addEventListener('click', () => window.print());
        pdfBtn.addEventListener('click', () => exportToPDF());
        
        shareBtn.addEventListener('click', () => {
            const shareLink = getShareLink();
            navigator.clipboard.writeText(shareLink).then(() => {
                showMessage("Link Copiado!", "O link com os dados da sua simulação foi copiado para a área de transferência.");
            }).catch(err => {
                console.error('Erro ao copiar link: ', err);
                showMessage("Erro", "Não foi possível copiar o link. Por favor, copie manualmente da barra de endereços.");
            });
        });

        whatsappBtn.addEventListener('click', () => {
            const resultado = calcRescisao({
                tipoDesligamento: tipoDesligamentoSelect.value,
                salarioBase: parseCurrency($('#salarioBase').value),
                dataAdmissao: $('#dataAdmissao').value,
                dataDesligamento: $('#dataDesligamento').value,
                avisoModelo: $('#avisoModelo').value,
                faltasDescontos: parseCurrency($('#faltasDescontos').value),
                feriasVencidas: $('#feriasVencidas').checked,
                fgtsOption: fgtsOptionSelect.value,
                fgtsSaldo: parseCurrency($('#fgtsSaldo').value),
                fgtsMeses: parseInt($('#fgtsMeses').value) || 0,
                mediaHorasExtras: parseCurrency($('#mediaHorasExtras').value),
                mediaAdicionais: parseCurrency($('#mediaAdicionais').value),
                mediaComissoes: parseCurrency($('#mediaComissoes').value),
                pensaoAbre: pensaoAbreCheckbox.checked,
                pensaoValor: parseCurrency($('#pensaoValor').value)
            });
            
            const shareText = `*Simulação de Rescisão - Dr. Marcílio*\n\n` +
                             `*Tipo:* ${$('#tipoDesligamento option:checked').text}\n` +
                             `*Líquido a Receber:* ${formatCurrency(resultado.liquido)}\n` +
                             `*Bruto:* ${formatCurrency(resultado.bruto)}\n` +
                             `*Descontos:* ${formatCurrency(resultado.descontos)}\n\n` +
                             `*Detalhes:* \n${Object.entries(resultado.verbas).map(([key, val]) => `- ${key}: ${formatCurrency(val.valor)}`).join('\n')}\n\n` +
                             `*Link da simulação:* ${getShareLink()}`;

            const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
            window.open(url, '_blank');
        });

    </script>
</body>
</html>
